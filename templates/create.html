{% extends "base.html" %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card">
            <div class="card-body p-5">
                <h2 class="text-center mb-4">Create Meeting Summary</h2>
                
                <div id="loader" class="text-center" style="display: none;">
                    <div class="loader mx-auto mb-3"></div>
                    <p id="status-text">Processing your meeting...</p>
                </div>

                <form id="meetingForm" onsubmit="return submitForm(event)">
                    <div class="mb-3">
                        <label class="form-label">Meeting Title</label>
                        <input type="text" class="form-control" name="title" 
                               placeholder="Weekly Team Sync" required>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Meeting Type</label>
                        <select class="form-select" name="type">
                            <option value="Team meeting">Team meeting</option>
                            <option value="Client call">Client call</option>
                            <option value="Interview">Interview</option>
                            <option value="Standup">Standup</option>
                            <option value="Workshop">Workshop</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Upload Meeting Recording</label>
                        <input type="file" class="form-control" id="fileInput" 
                               accept=".mp3,.wav,.mp4,.m4a">
                        <div class="form-text">Supported formats: MP3, WAV, MP4</div>
                    </div>

                    <div class="mb-4">
                        <label class="form-label">OR Paste Transcript</label>
                        <textarea class="form-control" name="transcript" rows="6" 
                                  placeholder="Paste meeting transcript here..."></textarea>
                    </div>

                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-primary btn-lg">
                            <i class="bi bi-robot"></i> Generate Summary
                        </button>
                        
                        <button type="button" class="btn btn-outline-primary" 
                                onclick="showMeetJoinModal()">
                            <i class="bi bi-camera-video"></i> Join Google Meet
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Google Meet Modal -->
<div class="modal fade" id="meetModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Join Google Meet</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Meeting Title</label>
                    <input type="text" class="form-control" id="meetTitle" 
                           placeholder="Google Meet Session">
                </div>
                <div class="mb-3">
                    <label class="form-label">Meeting Type</label>
                    <select class="form-select" id="meetType">
                        <option value="Team meeting">Team meeting</option>
                        <option value="Client call">Client call</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label">Google Meet URL</label>
                    <input type="url" class="form-control" id="meetUrl" 
                           placeholder="https://meet.google.com/abc-defg-hij" required>
                </div>
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i> The bot will join the meeting and 
                    capture the conversation for summarization.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="joinGoogleMeet()">Join Meeting</button>
            </div>
        </div>
    </div>
</div>

<script>
function submitForm(event) {
    event.preventDefault();
    
    const form = document.getElementById('meetingForm');
    const formData = new FormData(form);
    
    const fileInput = document.getElementById('fileInput');
    if (fileInput.files[0]) {
        formData.append('file', fileInput.files[0]);
    }
    
    showLoader();
    
    fetch('/create', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            window.location.href = `/meeting/${data.meeting_id}`;
        } else {
            hideLoader();
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        hideLoader();
        alert('Error: ' + error);
    });
    
    return false;
}

function showLoader() {
    document.getElementById('loader').style.display = 'block';
    document.getElementById('meetingForm').style.opacity = '0.5';
}

function hideLoader() {
    document.getElementById('loader').style.display = 'none';
    document.getElementById('meetingForm').style.opacity = '1';
}

function showMeetJoinModal() {
    const modal = new bootstrap.Modal(document.getElementById('meetModal'));
    modal.show();
}

function joinGoogleMeet() {
    const url = document.getElementById('meetUrl').value;
    const title = document.getElementById('meetTitle').value;
    const type = document.getElementById('meetType').value;
    
    if (!url) {
        alert('Please enter Google Meet URL');
        return;
    }
    
    showLoader();
    bootstrap.Modal.getInstance(document.getElementById('meetModal')).hide();
    
    fetch('/api/join-meet', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ meet_url: url, title: title, type: type })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            window.location.href = `/meeting/${data.meeting_id}`;
        } else {
            hideLoader();
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        hideLoader();
        alert('Error: ' + error);
    });
}
</script>
{% endblock %}